<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>内部記録検索端末</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="terminal">
    <h1>内部記録検索端末</h1>
    <input id="query" type="text" placeholder="キーワードを入力" autofocus>
    <button id="searchBtn">SEARCH</button>
    <div id="results"></div>
  </div>

<script>
  // ======================
  // 要素参照
  // ======================
  const input  = document.getElementById('query');
  const btn    = document.getElementById('searchBtn');
  const result = document.getElementById('results');

  // JSON DB のパス
  const DB_URL = "data/index.json";

  // 読み込んだDBを保持
  let DB = null;
  let dbLoaded = false;
  let dbLoadError = false;

  // ======================
  // DB読み込み
  // ======================
  async function loadDB() {
    if (dbLoaded || dbLoadError) return; // 一度試行したら再度fetchしない
    try {
      // データのキャッシュを防ぐために no-cache を使用
      const res = await fetch(DB_URL, { cache: "no-cache" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      DB = await res.json();
      dbLoaded = true;
    } catch (e) {
      console.error("DB読み込みエラー:", e);
      dbLoadError = true;
      result.innerHTML = "<p>検索データの読み込みに失敗しました。</p>";
    }
  }

  // ======================
  // 検索ロジック (【ここを修正】)
  // ======================
  async function search() {
    const q = (input.value || "").trim().toLowerCase();
    result.innerHTML = "";

    if (!q) {
      return;
    }

    // DBがまだなら読み込み
    if (!dbLoaded && !dbLoadError) {
      await loadDB();
    }
    if (dbLoadError || !DB) {
      result.innerHTML = "<p>検索データの読み込みに失敗しました。</p>";
      return;
    }

    // マッチするエントリを抽出
    const hits = DB.filter(item => {
      if (!Array.isArray(item.keys)) return false;
      return item.keys.some(k => {
        if (!k) return false;
        // 修正: キーワード k の中にクエリ q が含まれているかをチェックする
        // 以前のロジック (q.includes(k)) では、クエリがキーワードより短い場合に失敗していた
        return String(k).toLowerCase().includes(q); 
      });
    });

    if (hits.length === 0) {
      result.innerHTML = `<p>「${escapeHtml(q)}」に一致するデータは見つかりませんでした。</p>`;
      return;
    }

    // 検索結果を描画
    renderHits(hits, q);
  }

  // ======================
  // 結果描画 (【ここを修正】Base64処理を再導入)
  // ======================
  function renderHits(hits, q) {
    const escQ = escapeHtml(q);
    const html = [];

    html.push(`<h2>「${escQ}」の検索結果 (${hits.length}件)</h2>`);
    html.push("<ul class=\"hit-list\">");

    hits.forEach(doc => {
      const title   = escapeHtml(doc.title || "（無題）");
      const snippet = escapeHtml((doc.snippet || "").toString());
      const file    = doc.file || "";
      const type    = doc.type || "";
      const id      = doc.id || ""; 

      let typeLabel = "";
      if (type === "log")  typeLabel = "[内部記録]";
      if (type === "site") typeLabel = "[院内サイト]";
      if (type === "other") typeLabel = "[その他]";
      
      let dataAttr = "";
      let targetFile = "";
      
      // ログまたは docs.js 由来の文書の場合
      if (type === "log") {
        // Base64 エンコードする対象は、ファイルパス (.txt) または docs.js の ID
        targetFile = file && file.endsWith('.txt') ? file : id;
        dataAttr = `data-h="${btoa(targetFile)}"`; // Base64 エンコードして data-h に設定
      } else if (type === "site") {
        // 病院サイトの場合: 実際のファイルパス (file) を data-file に設定
        dataAttr = `data-file="${encodeHtmlAttr(file)}"`;
      }


      html.push(`
        <li class="hit">
          <h3 class="doc-title"
              ${dataAttr}
              data-type="${type}"
              style="cursor:pointer; text-decoration:underline;">
            ${typeLabel ? `<span class="hit-type">${typeLabel}</span> ` : ""}${title}
          </h3>
          <p class="snippet">${snippet}</p>
        </li>
      `);
    });

    html.push("</ul>");
    result.innerHTML = html.join("");

    // クリックイベントのロジックを修正
    document.querySelectorAll(".doc-title").forEach(el => {
      el.addEventListener("click", () => {
        const type = el.getAttribute("data-type");
        
        if (type === "log") {
          // 内部記録（log）の場合: Base64 エンコードされたキーを record.html に渡す
          const base64Key = el.getAttribute("data-h");
          if (base64Key) {
            window.open(`record.html?h=${base64Key}`, "_blank");
          }
        } else if (type === "site") {
          // 病院サイト（site）の場合: 既存のファイルパスを直接開く
          const file = el.getAttribute("data-file");
          if (file) {
            window.open(file, "_blank");
          }
        }
      });
    });
  }


  // ======================
  // ユーティリティ：エスケープ (変更なし)
  // ======================
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function encodeHtmlAttr(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  // ======================
  // 初期処理：?q= を拾って自動検索 (変更なし)
  // ======================
  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(location.search);
    const qParam = (params.get("q") || "").trim();
    if (qParam) {
      input.value = qParam;
      await search();
    }
  });

  // ======================
  // イベント設定 (変更なし)
  // ======================
  btn.addEventListener("click", () => {
    search();
  });

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      search();
    }
  });
</script>
</body>
</html>
