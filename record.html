<!doctype html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>内部記録ビューア：接続中</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="top-nav">
        <a href="search.html">>> 記録検索システムへ戻る</a>
        <span class="nav-divider">|</span>
        <a href="index.html">>> 依頼サイトへ戻る</a>
        <span class="nav-status">状態：アクセス許可済み</span>
    </nav>
    
<div class="terminal record">
    <div class="terminal-header">
        > CONNECTED: 翠波ネットワーク / 記録検索端末
        <br>
        > FETCHING FILE　・・・・
        <span class="status-light" id="status-light" title="接続状態"></span>
    </div>

    <h1 id="title"></h1>
    <div id="body" class="markdown-body"></div>
    
    <div class="terminal-footer">
        <p class="disclaimer">
            ※本サイトはフィクションであり、ARG（代替現実ゲーム）の一部として作成されたものです。 実在の病院・団体・医療行為とは一切関係ありません。
        </p>
    </div>
</div>

<script src="./js/lib/marked.min.js"></script>
<script>
    (function() {
        const params = new URLSearchParams(location.search);
        const h = params.get("h");

        const titleElement = document.getElementById("title");
        const bodyElement = document.getElementById("body");
        const statusLight = document.getElementById("status-light");
        
        let recordPath = ""; 

        try {
            recordPath = atob(h);
        } catch (e) {
            titleElement.innerText = "文書の読み込みエラー: 無効なキー";
            statusLight.className = 'status-light'; 
            return; 
        }

        async function fetchRecordData(targetPath) {
            const normalizePath = (p) => String(p).replace(/^\/|\/$/g, '');
            
            // index.json の取得
            const indexResponse = await fetch('data/index.json'); 
            if (!indexResponse.ok) throw new Error(`[CRITICAL] 目録データ通信エラー`);
            
            const indexData = await indexResponse.json();
            const targetPathNormalized = normalizePath(targetPath);
            
            const record = indexData.find(item => normalizePath(item.file) === targetPathNormalized);
            if (!record) throw new Error(`[CRITICAL] 記録データ照合失敗`);
            
            let logFilePath = record.file;
            if (logFilePath.startsWith('/')) logFilePath = logFilePath.substring(1); 
            
            const logResponse = await fetch(logFilePath);
            if (!logResponse.ok) throw new Error(`[CRITICAL] ログファイル通信エラー`);
            
            const logContent = await logResponse.text();
            return { title: record.title, content: logContent };
        }

        titleElement.innerText = `データ転送中...`; 
        
        setTimeout(() => {
            fetchRecordData(recordPath)
                .then(data => {
                    statusLight.className = 'status-light ok';
                    const trimmedData = data.content.trim();

                    if (!trimmedData) {
                        titleElement.innerText = "記録が存在しないか、データが破損しています";
                        bodyElement.innerText = "ファイルは存在しますが、内容は空です。";
                        return;
                    }

                    titleElement.innerText = `内部記録: ${data.title}`; 
                    // Markdownとしてパースして表示
                    if (typeof marked !== 'undefined') {
                        bodyElement.innerHTML = marked.parse(trimmedData);
                    } else {
                        bodyElement.innerText = trimmedData;
                    }
                })
                .catch(e => {
                    statusLight.className = 'status-light';
                    titleElement.innerText = "接続断 / アクセス失敗";
                    bodyElement.innerText = `【FATAL ERROR】\n\n${e.message}\n\n通信プロトコルの破損が確認されました。`;
                });
        }, 500);
    })();
</script>
</body>
</html>
