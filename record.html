<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>内部記録ビューア：接続中</title>
  <link rel="stylesheet" href="style.css"> 
</head>
<body>

  <div class="terminal record"> 
    
    <div class="terminal-header">
        > CONNECTED: 翠波ネットワーク / 記録検索端末
        <br>
        > FETCHING FILE　・・・・
        <span class="status-light" id="status-light" title="接続状態"></span>
    </div>

    <h1 id="title"></h1>
    <pre id="body" style="white-space:pre-wrap;"></pre>
    
    <div class="terminal-footer">
        <p class="disclaimer">
            ※本サイトはフィクションであり、ARG（代替現実ゲーム）の一部として作成されたものです。 実在の病院・団体・医療行為とは一切関係ありません。
        </p>
    </div>
  </div>

  <script>
    // 即時実行関数で全体をラップし、return 文を有効にする
    (function() {
      const params = new URLSearchParams(location.search);
      const h = params.get("h");

      const titleElement = document.getElementById("title");
      const bodyElement = document.getElementById("body");
      const pathElement = document.getElementById("access-path");
      const statusLight = document.getElementById("status-light");
      
      let decodedKey = "";
      try {
        // Base64 デコード (ファイルパス)
        decodedKey = atob(h);
        pathElement.innerText = decodedKey; // デコードしたキーを表示
      } catch (e) {
        titleElement.innerText = "文書の読み込みエラー: 無効なキー";
        statusLight.className = 'status-light'; 
        return; 
      }
      
      // ===============================================
      // logs/*.txt ファイルパスの場合、fetch で内容を取得
      // ===============================================
      // docs.js の文書がなくなったため、この if ブロックにすべて集約されます。

      if (decodedKey.startsWith('logs/') && decodedKey.endsWith('.txt')) {
        const logFileName = decodedKey.split('/')[1];
        titleElement.innerText = `データ転送中... (ファイル: ${logFileName})`;

        const fetchPath = decodedKey; // logs/ランダム名.txt
        
        // 0.5秒の遅延を設けて、読み込み演出と非同期処理の確実性を高める
        setTimeout(() => {
            
          fetch(fetchPath)
            .then(response => {
              if (!response.ok) {
                // 404 (Not Found) などのエラーをここでキャッチ
                throw new Error(`HTTP ERROR ${response.status}: ${response.statusText || 'ファイルが見つかりません (404)'}`);
              }
              return response.text();
            })
            .then(data => {
              // 成功
              statusLight.className = 'status-light ok';
              
              const trimmedData = data.trim();

              if (!trimmedData) {
                  titleElement.innerText = "記録が存在しないか、データが破損しています";
                  bodyElement.innerText = "ファイルは存在しますが、内容は空です。";
                  return;
              }

              // ★ ファイル内容を本文に設定
              bodyElement.innerText = trimmedData;

              // タイトル設定 (本文の最初の行を利用)
              const firstLine = trimmedData.split('\n')[0];
              if (firstLine.startsWith('[source')) {
                titleElement.innerText = firstLine.replace(/\\s*【/, '').replace(/】\s*$/, '').trim();
              } else {
                titleElement.innerText = `内部記録（ファイル名: ${logFileName}）`;
              }
            })
            .catch(e => {
              // 失敗時に詳細なエラーを画面に表示
              statusLight.className = 'status-light';
              titleElement.innerText = "接続断 / アクセス失敗";
              bodyElement.innerText = `【FATAL ERROR】\n\nパス試行: ${fetchPath}\nエラー内容: ${e.message}\n\n機密区画は封鎖されました。`;
              console.error("ARG Fetch Error:", e); 
            });
        }, 500);
        
        return; 
      }

      // ===============================================
      // 3. .txt パスではなかった場合
      // ===============================================
      statusLight.className = 'status-light';
      titleElement.innerText = "文書が見つかりません";
    })(); // 即時実行
  </script>
</body>
</html>
